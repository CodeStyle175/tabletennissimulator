<!DOCTYPE>
<html>
	<head>
		<title>Table Tennis Game</title>
		<meta charset="UTF-8">
		<script type="text/javascript" src="static/three.r96.js"></script>
		<script type="text/javascript" src="static/MTLLoader.js"></script>
		<script type="text/javascript" src="static/OBJLoader.js"></script>
		<script type="text/javascript">

			var renderer, scene, camera;
			
			var table; //objects
			var assetsToLoad = 1;
			var textureLoader = new THREE.TextureLoader();
			
			function toRad(degree) {
				return Math.PI * 2 * degree / 360;
			}

			function millis() {
				return (new Date()).getTime();
			}
		
			function onLoad() { 
				var canvasContainer = document.getElementById('canvasContainer'); 
				var width = window.innerWidth; 
				var height = window.innerHeight;
				
				renderer = new THREE.WebGLRenderer(); 
				renderer.setSize(width, height);
				renderer.gammaInput = true;
				renderer.gammaOutput = true;
				canvasContainer.appendChild(renderer.domElement);
				
				scene = new THREE.Scene();
				
				camera = new THREE.PerspectiveCamera(80, width / height, 1, 1000);
				camera.up = new THREE.Vector3(0, 1, 0);
				camera.position.set(0, 0, 18);

				var directionalLight = new THREE.DirectionalLight();
				directionalLight.position.set(1, 1, 1);
				scene.add(directionalLight);

				var light = new THREE.PointLight(0xffffff);
				light.position.set(0,2.5,2);
				scene.add(light);

				addEvironment();

				// Load the table
				var mtlLoader = new THREE.MTLLoader();
				mtlLoader.load('static/10520_pingpongtable_L2.mtl', function(materials) {
					var objLoader = new THREE.OBJLoader();
					objLoader.setMaterials(materials);
					objLoader.load('static/10520_pingpongtable_L2.obj', loadTable);
				});

				// Load a paddle
				var mtlLoader = new THREE.MTLLoader();
				mtlLoader.load('static/paddle.mtl', function(materials) {
					var objLoader = new THREE.OBJLoader();
					objLoader.setMaterials(materials);
					objLoader.load('static/paddle.obj', loadPaddle);
				});
			}

			function loadPaddle(paddle) {
				console.log(paddle);
				paddle.position.set(0, -3, 5);
				paddle.name = "Paddle";
				paddle.scale.set(0.1, 0.1, 0.1);
				paddle.rotation.set(toRad(-90), 0, 0);

				scene.add(paddle);
				
				if (!(--assetsToLoad)) {
					loaded();
				}
			}

			function loadTable(table) {

				table.position.set(0, -10, -3);
				table.name = "Table";
				table.scale.set(0.08, 0.06, 0.06);
				table.rotation.set(toRad(-90), 0, 0);

				scene.add(table);
				
				if (!(--assetsToLoad)) {
					loaded();
				}
			}
			
			function onTextureLoaded(texture) {
				texture.wrapS = THREE.RepeatWrapping;
				texture.wrapT = THREE.RepeatWrapping;
				texture.repeat.set(2, 10);
				texture.needsUpdate = true;
				
				if (!(--assetsToLoad)) {
					loaded();
				}
			}
			
			function loaded() {
				draw();
			}
			
			function draw() {
				requestAnimationFrame(draw);
				renderer.render(scene, camera);
			}
			

			function addEvironment() {
				var hangar = new THREE.Object3D();
				var halfPi = Math.PI / 2;
				
				var floor = createWall(0x222222, 100, 200);
				floor.position.set(0, -10, 40);
				floor.rotation.set(-halfPi, 0, 0);

				var backWall = createWall(0x222222, 70, 100);
				backWall.position.set(0, 0, -20);
				backWall.rotation.set(0, 0, -halfPi);

				var leftWall = createWall(0x222222, 70, 100);
				leftWall.position.set(-30, 0, -20);
				leftWall.rotation.set(0, halfPi, -halfPi);

				var rightWall = createWall(0x222222, 70, 100);
				rightWall.position.set(30, 0, -20);
				rightWall.rotation.set(0, -halfPi, -halfPi);
				
				floor.material = new THREE.MeshLambertMaterial({
					map: textureLoader.load('static/white_wall.jpg', onTextureLoaded)
				});

				backWall.material = new THREE.MeshLambertMaterial({
					map: textureLoader.load('static/dark_wall.jpg', onTextureLoaded)
				});

				leftWall.material = new THREE.MeshLambertMaterial({
					map: textureLoader.load('static/dark_wall.jpg', onTextureLoaded)
				});

				rightWall.material = new THREE.MeshLambertMaterial({
					map: textureLoader.load('static/dark_wall.jpg', onTextureLoaded)
				});

				hangar.add(floor);
				hangar.add(backWall);
				hangar.add(leftWall);
				hangar.add(rightWall);
				
				scene.add(hangar);
			}
			
			function createWall(colorCode, width, height) {
				var geometry = new THREE.PlaneGeometry(width, height, width, height);
				var material = new THREE.MeshBasicMaterial({color: colorCode});
				var wall = new THREE.Mesh(geometry, material);
				
				return wall;
			}
			
		</script>
	</head>
	<body onload="onLoad()">
		<div id="canvasContainer"></div>
	</body>
</html>